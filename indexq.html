<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Digital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 20px;
            gap: 20px;
        }
        
        .canvas-container {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #signatureCanvas {
            border: 2px dashed #ccc;
            border-radius: 5px;
            cursor: crosshair;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 10px 0;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        #finalizeBtn {
            background-color: #3498db;
            color: white;
        }
        
        #saveBtn {
            background-color: #27ae60;
            color: white;
        }
        
        #clearBtn {
            background-color: #e74c3c;
            color: white;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            color: #555;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Firma Digital</h1>
    </div>
    
    <div class="container">
        <div class="canvas-container">
            <canvas id="signatureCanvas"></canvas>
        </div>
        
        <div class="controls">
            <button id="finalizeBtn">Finalizar firma</button>
            <button id="saveBtn">Guardar firma</button>
            <button id="clearBtn">Limpiar</button>
        </div>
        
        <div class="status" id="status">Firme en el área de arriba</div>
    </div>

    <script>
        // Parámetros de configuración (serán pasados como query params o configurados)
        let documento = getParameterByName('documento') || '';
        let servidor = getParameterByName('servidor') || '';
        
        // Elementos del DOM
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        const finalizeBtn = document.getElementById('finalizeBtn');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusElement = document.getElementById('status');
        
        // Variables para el dibujo
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let hasSignature = false;
        
        // Configurar el tamaño del canvas
        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            const containerWidth = container.clientWidth - 40; // 20px padding each side
            const containerHeight = container.clientHeight - 40; // 20px padding each side
            
            // Establecer dimensiones del canvas
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            // Establecer estilos CSS para el tamaño de visualización
            canvas.style.width = `${containerWidth}px`;
            canvas.style.height = `${containerHeight}px`;
            
            // Configurar el contexto del canvas
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000';
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // Obtener parámetros de la URL
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        // Inicializar el canvas
        function initCanvas() {
            resizeCanvas();
            
            // Eventos de dibujo
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Eventos táctiles para dispositivos móviles
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Botones
            clearBtn.addEventListener('click', clearCanvas);
            finalizeBtn.addEventListener('click', finalizeSignature);
            saveBtn.addEventListener('click', saveSignature);
            
            // Redimensionar al cambiar el tamaño de la ventana
            window.addEventListener('resize', resizeCanvas);
        }
        
        // Manejar eventos táctiles
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        // Funciones de dibujo
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            
            [lastX, lastY] = [e.offsetX, e.offsetY];
            hasSignature = true;
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        // Limpiar el canvas
        function clearCanvas() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            statusElement.textContent = "Firme en el área de arriba";
        }
        
        // Finalizar la firma (redimensionar)
        function finalizeSignature() {
            if (!hasSignature) {
                statusElement.textContent = "Por favor, firme primero antes de finalizar.";
                return;
            }
            
            // Crear una copia del canvas actual
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);
            
            // Encontrar los límites de la firma
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            let minX = tempCanvas.width, minY = tempCanvas.height;
            let maxX = 0, maxY = 0;
            let foundPixel = false;
            
            for (let y = 0; y < tempCanvas.height; y++) {
                for (let x = 0; x < tempCanvas.width; x++) {
                    const i = (y * tempCanvas.width + x) * 4;
                    // Si el pixel no es blanco (consideramos no blanco si no es completamente blanco)
                    if (data[i] < 250 || data[i+1] < 250 || data[i+2] < 250) {
                        foundPixel = true;
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }
                }
            }
            
            if (!foundPixel) {
                statusElement.textContent = "No se detectó ninguna firma.";
                return;
            }
            
            // Añadir un pequeño margen
            const margin = 5;
            minX = Math.max(0, minX - margin);
            minY = Math.max(0, minY - margin);
            maxX = Math.min(tempCanvas.width, maxX + margin);
            maxY = Math.min(tempCanvas.height, maxY + margin);
            
            // Calcular dimensiones del recorte
            const cropWidth = maxX - minX;
            const cropHeight = maxY - minY;
            
            // Crear canvas para el recorte
            const cropCanvas = document.createElement('canvas');
            const cropCtx = cropCanvas.getContext('2d');
            cropCanvas.width = cropWidth;
            cropCanvas.height = cropHeight;
            
            // Recortar la firma
            cropCtx.drawImage(tempCanvas, minX, minY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            
            // Calcular nuevas dimensiones manteniendo proporciones
            const targetWidth = 250;
            const targetHeight = 83;
            const aspectRatio = cropWidth / cropHeight;
            const targetAspectRatio = targetWidth / targetHeight;
            
            let newWidth, newHeight;
            
            if (aspectRatio > targetAspectRatio) {
                // La firma es más ancha que el objetivo
                newWidth = targetWidth;
                newHeight = targetWidth / aspectRatio;
            } else {
                // La firma es más alta que el objetivo
                newHeight = targetHeight;
                newWidth = targetHeight * aspectRatio;
            }
            
            // Crear canvas final
            const finalCanvas = document.createElement('canvas');
            const finalCtx = finalCanvas.getContext('2d');
            finalCanvas.width = targetWidth;
            finalCanvas.height = targetHeight;
            
            // Rellenar con blanco
            finalCtx.fillStyle = '#fff';
            finalCtx.fillRect(0, 0, targetWidth, targetHeight);
            
            // Calcular posición para centrar
            const x = (targetWidth - newWidth) / 2;
            const y = (targetHeight - newHeight) / 2;
            
            // Dibujar la firma redimensionada
            finalCtx.drawImage(cropCanvas, 0, 0, cropWidth, cropHeight, x, y, newWidth, newHeight);
            
            // Mostrar la firma final en el canvas principal
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const displayWidth = Math.min(canvas.width, 300);
            const displayHeight = (displayWidth / targetWidth) * targetHeight;
            const displayX = (canvas.width - displayWidth) / 2;
            const displayY = (canvas.height - displayHeight) / 2;
            ctx.drawImage(finalCanvas, 0, 0, targetWidth, targetHeight, displayX, displayY, displayWidth, displayHeight);
            
            // Guardar la firma final para su posterior envío
            window.finalSignatureCanvas = finalCanvas;
            
            statusElement.textContent = `Firma redimensionada a ${targetWidth}x${targetHeight} px (proporciones conservadas)`;
        }
        
        // Guardar y enviar la firma
        function saveSignature() {
            if (!window.finalSignatureCanvas) {
                statusElement.textContent = "Por favor, finalice la firma primero.";
                return;
            }
            
            // Convertir a JPEG
            const jpegDataUrl = window.finalSignatureCanvas.toDataURL('image/jpeg', 0.9);
            
            // Convertir a Blob
            fetch(jpegDataUrl)
                .then(res => res.blob())
                .then(blob => {
                    // Crear FormData
                    const formData = new FormData();
                    formData.append('userfile', blob, 'signature.jpg');
                    formData.append('documento', documento);
                    
                    // Enviar al servidor
                    fetch(servidor, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            statusElement.textContent = "Firma guardada exitosamente.";
                            statusElement.style.color = "#27ae60";
                        } else {
                            throw new Error('Error en la respuesta del servidor');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        statusElement.textContent = "Error al guardar la firma: " + error.message;
                        statusElement.style.color = "#e74c3c";
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusElement.textContent = "Error al procesar la firma: " + error.message;
                    statusElement.style.color = "#e74c3c";
                });
        }
        
        // Inicializar la aplicación
        window.addEventListener('load', () => {
            initCanvas();
            
            // Mostrar parámetros recibidos
            console.log('Documento:', documento);
            console.log('Servidor:', servidor);
            
            if (!servidor) {
                statusElement.textContent = "Advertencia: No se especificó URL de servidor.";
                statusElement.style.color = "#f39c12";
            }
        });
    </script>
</body>
</html>